<html>
    <head>
        <title>‡∏ì‡∏±‡∏ê‡∏û‡∏±‡∏ä‡∏£‡πå ‡∏ô.</title>
        <link rel="stylesheet" href="./css/chatBox.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    </head>
    <body>
        <nav>
            <a href="./index.html"><h1>‡∏ì‡∏±‡∏ê‡∏û‡∏±‡∏ä‡∏£‡πå ‡∏ô.</h1></a>
            <ul class="navigation-items">
                <li class="navigation-item">
                    <a href="./ai.html">AI</a>
                </li>
                <li class="navigation-item">
                    <a href="./about-me.html">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a>
                </li>
            </ul>
        </nav>

        <hr>

        <main>
            <div id="page-container">
                <div id="chatbox"></div>
                <div id="input-section">
                <input id="input" type="text" placeholder="Aa" />
                <button onclick="send()">‚ñ∂</button>
                </div>
            </div>
            <footer>
            </footer>
        </main>

        <script>
            const testChat = false;
            const testTTS = false;
            const greetingMsg = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏≤";
            const chatbox = document.getElementById('chatbox');
            const input = document.getElementById('input');

            const currentNgrok = 'https://a65fe6d4b7e9.ngrok-free.app'

            const webhookAiUrl = currentNgrok+'/webhook/chat';
            const webhookTestAiUrl = currentNgrok+'/webhook-test/chat';
            const webhookTtsUrl = currentNgrok+'/webhook/textToSpeech'
            const webhookTestTtsUrl = currentNgrok+'/webhook-test/textToSpeech';

            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á UI Chatbox ‡πÉ‡∏ô Element ‡∏ó‡∏µ‡πà‡∏°‡∏µ id="page-container"
            document.addEventListener('DOMContentLoaded', function() {
                input.addEventListener('keypress', function(event){
                    if (event.key === 'Enter' || event.key === 13) {
                        event.preventDefault();
                        send();
                    }
                })
            });

            setTimeout(function() {
                appendMessage(greetingMsg, 'bot')
            }, 2000)

            // ‡∏û‡∏π‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            function speakWithGoogleTranslate(text) {
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!text) return;

                // 2. ‡∏•‡∏ö‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©
                const cleanText = text.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\u200D|\uFE0F|[\u2600-\u27BF]|\u23F0|\u23F3/g, '');

                // 3. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL
                const encodedText = encodeURIComponent(cleanText);
                const lang = 'th';

                // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Translate TTS
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=${lang}&client=tw-ob`;

                // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á Audio Element ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                const audio = new Audio(url);
                audio.play()
                .catch(error => {
                    console.error('Error playing audio:', error);
                });
            }

            // ‡∏ó‡∏≥‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô
            function createTypingIndicator() {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container', 'bot-message');

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö Typing Indicator)
                const messageImage = document.createElement('img');
                messageImage.classList.add('icon');
                messageImage.src = "./img/bronya.png";
                messageImage.alt = "Bot Icon";
                messageContainer.appendChild(messageImage);

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° span ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î "..."
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('typing-indicator');
                
                for (let i = 0; i < 3; i++){
                    const dot = document.createElement('span');
                    dot.classList.add('dot');
                    typingIndicator.appendChild(dot);
                }
                
                messageContainer.appendChild(typingIndicator);

                return messageContainer;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
            function getSessionId() {
                let sessionId = localStorage.getItem('chatSessionId');
                //const lockSessionId = 'session_93qq8mabph9vmtfpkd91kk'
                if (!sessionId) {
                    sessionId = 'session_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('chatSessionId', sessionId);
                }
                return lockSessionId;
            }

            function appendMessage(text, sender) {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container', sender === 'user' ? 'user-message' : 'bot-message');

                if (sender === 'bot'){
                    const messageImage = document.createElement('img');
                    messageImage.classList.add('icon');
                    messageImage.src = "./img/bronya.png";
                    messageImage.alt = "Bot Icon";
                    messageContainer.appendChild(messageImage);
                }

                const messageText = document.createElement('span');
                messageText.classList.add(sender === 'user' ? 'user-text' : 'bot-text'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ user-text ‡∏´‡∏£‡∏∑‡∏≠ bot-text
                messageText.innerText = text; //

                messageContainer.appendChild(messageText);

                if (sender === 'bot'){
                    const messageButton = document.createElement('button');
                    messageButton.classList.add('bot-button');
                    messageButton.innerText = 'üîä';
                    messageButton.addEventListener('click', () => {
                        speakWithGoogleTranslate(text);
                    });

                    messageContainer.appendChild(messageButton);
                }
                
                
                chatbox.appendChild(messageContainer);
                if (sender === 'bot') speakWithGoogleTranslate(text);
                
                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô scrollbar ‡∏•‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                //chatbox.scrollTop = chatbox.scrollHeight;

                return messageContainer; // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô element ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö "Thinking..." ‡πÑ‡∏î‡πâ
            }

            async function send() {
                const sessionId = getSessionId();
                const text = input.value.trim();
                
                if (!text) return;
                appendMessage(text, 'user');
                input.value = ''; //‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á input

                //const thinkingMessage = appendMessage('...', 'bot'); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "Thinking..."
                const thinkingMessage = createTypingIndicator();
                chatbox.appendChild(thinkingMessage);
                chatbox.scrollTop = chatbox.scrollHeight;

                try {
                    const res = await fetch((testChat ? webhookTestAiUrl : webhookAiUrl), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: text,
                        sessionId: sessionId })
                    });

                    const data  = await res.json();
                    console.log('üßæ Raw response:', data.resTxt);

                    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "Thinking..." ‡∏≠‡∏≠‡∏Å
                    chatbox.removeChild(thinkingMessage);

                    const botResponse = data.resTxt || "‡πÑ‡∏°‡πà‡∏°‡∏µ response";

                    appendMessage(botResponse, 'bot');

                } catch (e) {
                    console.error('Error:', e)
                    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "Thinking..." ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error
                    if (thinkingMessage && chatbox.contains(thinkingMessage)) {
                        chatbox.removeChild(thinkingMessage);
                    }
                    const errorMessage = "‚ùå error: " + e.message;
                    appendMessage(errorMessage, 'bot');
                }
            }
        </script>
        
    </body>

</html>

